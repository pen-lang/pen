version: 2.1
jobs:
  build:
    macos:
      xcode: 12.15.1
    parallelism: 2
    steps:
      - checkout
      - run: |
          llvm_prefix=$(brew --prefix)/opt/llvm@13

          echo export LLVM_SYS_130_PREFIX=$llvm_prefix >> ~/.profile
          echo export PATH=$llvm_prefix/bin:\$PATH >> ~/.profile
      - run: brew install jq llvm@13 ninja ruby sccache
      - run: tools/integration_test.sh $(circleci tests glob 'features/**/*.feature' | circleci tests split)
